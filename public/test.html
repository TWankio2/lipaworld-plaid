<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaid Microservice Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            padding: 2rem 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%);
        
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 0.75rem;
            border: 1px solid #475569;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-text {
            font-weight: 500;
            color: #e2e8f0;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid #475569;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: #60a5fa;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-section {
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: 1px solid #2563eb;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid #047857;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.8);
            color: #e2e8f0;
            border: 1px solid #475569;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(71, 85, 105, 1);
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #f1f5f9;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.7);
            color: #e2e8f0;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .response-area {
            grid-column: 1 / -1;
        }

        .response-box {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 0.75rem;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
            color: #cbd5e1;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .status-200 { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .status-400 { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fbbf24; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .status-500 { 
            background: rgba(239, 68, 68, 0.2); 
            color: #f87171; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .validation-result {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
        }

        .validation-result.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #6ee7b7;
        }

        .validation-result.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #f87171;
        }

        .validation-result.loading {
            background: rgba(107, 114, 128, 0.1);
            border-color: #6b7280;
            color: #9ca3af;
        }

        .validation-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .validation-icon.success { background: #10b981; color: white; }
        .validation-icon.error { background: #ef4444; color: white; }
        .validation-icon.loading { 
            background: #6b7280; 
            color: white; 
            animation: spin 1s linear infinite; 
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .endpoint-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-box h4 {
            color: #60a5fa;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .info-box p {
            color: #cbd5e1;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .endpoint-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* Scrollbar styling */
        .response-box::-webkit-scrollbar {
            width: 8px;
        }

        .response-box::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 4px;
        }

        .response-box::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.8);
            border-radius: 4px;
        }

        .response-box::-webkit-scrollbar-thumb:hover {
            background: rgba(71, 85, 105, 1);
        }
    </style>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
    <div class="header">
        <h1>🏦 Plaid Microservice Dashboard</h1>
        <p>Complete API Testing Interface</p>
        <div class="status-bar">
            <span class="status-text">Service Status:</span>
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Initializing...</span>
        </div>
    </div>

    <div class="main-container">
        <!-- Connection Validation -->
        <div class="card validation-section">
            <h3 class="card-title">🔐 Environment Validation</h3>
            <div class="info-box">
                <h4>Connection Test</h4>
                <p>Validates that your Plaid microservice can successfully connect to the sandbox environment using configured credentials.</p>
            </div>
            <button class="btn btn-primary" id="validateBtn">
                🔍 Validate Plaid Connection
            </button>
            <div class="validation-result" id="validationResult" style="display: none;">
                <div class="validation-icon" id="validationIcon">?</div>
                <span id="validationText">Validating...</span>
            </div>
        </div>

        <!-- Quick Tests -->
        <div class="card">
            <h3 class="card-title">🚀 Quick Tests</h3>
            <div class="quick-actions">
                <button class="btn btn-primary" id="healthBtn">
                    ❤️ Health Check
                </button>
                <button class="btn btn-success" id="linkTokenBtn">
                    🔗 Create Link Token
                </button>
                <button class="btn btn-success" id="plaidLinkBtn" disabled>
                    🏛️ Open Plaid Link
                </button>
            </div>
        </div>

        <!-- Custom Request Builder -->
        <div class="card">
            <h3 class="card-title">⚙️ Custom Request Builder</h3>
            
            <div class="form-group">
                <label class="form-label">📝 Request Body (JSON)</label>
                <textarea id="requestBody" class="form-control" placeholder="Enter JSON request body...">{
  "user_id": "user_12345",
  "client_name": "Test Application",
  "country_codes": ["US"],
  "language": "en",
  "products": ["transactions", "identity"]
}</textarea>
            </div>

            <div class="form-group">
                <label class="form-label">🎯 Endpoint</label>
                <select id="endpoint" class="form-control">
                    <option value="GET:/health">GET /health - Health Check</option>
                    <option value="POST:/link-token">POST /link-token - Create Link Token</option>
                    <option value="POST:/exchange-token">POST /exchange-token - Exchange Public Token</option>
                    <option value="POST:/accounts">POST /accounts - Get Account Info</option>
                    <option value="POST:/transactions">POST /transactions - Get Transactions</option>
                    <option value="POST:/identity">POST /identity - Get Identity Data</option>
                </select>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" id="sendRequestBtn">
                    📤 Send Request
                </button>
                <button class="btn btn-secondary" id="clearResponseBtn">
                    🗑️ Clear Response
                </button>
            </div>
        </div>

        <!-- Response Area -->
        <div class="card response-area">
            <h3 class="card-title">📊 Response Monitor</h3>
            <div id="responseStatus"></div>
            <div id="responseContent" class="response-box">
🎯 Welcome to the Plaid Microservice Test Dashboard

Quick Start Guide:
1. Click "Validate Plaid Connection" to verify your environment setup
2. Use "Health Check" to ensure the service is running properly  
3. Test "Create Link Token" to verify core Plaid functionality
4. Use "Open Plaid Link" to test the complete authentication flow
5. Build custom requests using the form above

Your responses will appear here in real-time...
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:3000';
        const API_KEY = '1aef789a9e16972b2c75729cbe6972eb129a09b62d4df900f207b8257ccbc702';
        
        // State
        let currentLinkToken = null;
        let isConnectionValidated = false;

        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const validateBtn = document.getElementById('validateBtn');
        const validationResult = document.getElementById('validationResult');
        const validationIcon = document.getElementById('validationIcon');
        const validationText = document.getElementById('validationText');
        const healthBtn = document.getElementById('healthBtn');
        const linkTokenBtn = document.getElementById('linkTokenBtn');
        const plaidLinkBtn = document.getElementById('plaidLinkBtn');
        const sendRequestBtn = document.getElementById('sendRequestBtn');
        const clearResponseBtn = document.getElementById('clearResponseBtn');
        const endpointSelect = document.getElementById('endpoint');
        const requestBodyTextarea = document.getElementById('requestBody');
        const responseStatus = document.getElementById('responseStatus');
        const responseContent = document.getElementById('responseContent');

        // Event Listeners
        validateBtn.addEventListener('click', validateConnection);
        healthBtn.addEventListener('click', () => makeRequest('GET', '/health'));
        linkTokenBtn.addEventListener('click', createLinkToken);
        plaidLinkBtn.addEventListener('click', openPlaidLink);
        sendRequestBtn.addEventListener('click', sendCustomRequest);
        clearResponseBtn.addEventListener('click', clearResponse);
        endpointSelect.addEventListener('change', updateRequestBody);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServiceHealth();
        });

        // Service Health Check
        async function checkServiceHealth() {
            try {
                statusText.textContent = 'Checking...';
                const response = await fetch(API_BASE + '/health');
                const data = await response.json();
                
                if (response.ok) {
                    statusDot.classList.add('connected');
                    statusText.textContent = `Connected (${data.plaid_environment || 'unknown'})`;
                } else {
                    statusText.textContent = `Service Error (${response.status})`;
                }
            } catch (error) {
                statusText.textContent = 'Service Offline';
                console.error('Health check failed:', error);
            }
        }

        // Validate Plaid Connection
        async function validateConnection() {
            showValidationResult('loading', 'Testing Plaid connection...');

            try {
                const testBody = {
                    user_id: "test_validation_" + Date.now(),
                    client_name: "Connection Validation Test",
                    country_codes: ["US"],
                    language: "en",
                    products: ["transactions"]
                };

                const response = await fetch(API_BASE + '/link-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify(testBody)
                });

                const data = await response.json();

                if (response.ok && data.link_token) {
                    isConnectionValidated = true;
                    plaidLinkBtn.disabled = false;
                    showValidationResult('success', `✅ Connection successful! Environment: ${getPlaidEnvironment(data)}`);
                    
                    // Update status indicator
                    statusDot.classList.add('connected');
                    statusText.textContent = `Validated (${getPlaidEnvironment(data)})`;
                } else {
                    isConnectionValidated = false;
                    showValidationResult('error', `❌ Connection failed: ${data.error || data.details || 'Unknown error'}`);
                }
            } catch (error) {
                isConnectionValidated = false;
                showValidationResult('error', `❌ Network error: ${error.message}`);
            }
        }

        // Create Link Token
        async function createLinkToken() {
            const body = {
                user_id: "test_user_" + Date.now(),
                client_name: "Test Application",
                country_codes: ["US"],
                language: "en",
                products: ["transactions", "identity"]
            };
            
            await makeRequest('POST', '/link-token', body);
            
            // Extract link token for Plaid Link
            try {
                const responseText = responseContent.textContent;
                const response = JSON.parse(responseText);
                if (response.link_token) {
                    currentLinkToken = response.link_token;
                    plaidLinkBtn.disabled = false;
                    console.log('✅ Link token stored for Plaid Link usage');
                }
            } catch (e) {
                console.warn('Could not extract link token from response');
            }
        }

        // Open Plaid Link
        function openPlaidLink() {
            if (!currentLinkToken) {
                alert('⚠️ Please create a link token first by clicking "Create Link Token"');
                return;
            }

            const handler = Plaid.create({
                token: currentLinkToken,
                onSuccess: (public_token, metadata) => {
                    console.log('✅ Plaid Link Success!');
                    console.log('📝 Public Token:', public_token);
                    console.log('📊 Metadata:', metadata);
                    
                    // Auto-populate exchange token request
                    requestBodyTextarea.value = JSON.stringify({
                        public_token: public_token,
                        user_id: "test_user_123"
                    }, null, 2);
                    
                    // Auto-select exchange endpoint
                    endpointSelect.value = "POST:/exchange-token";
                    
                    alert('✅ Bank connection successful! Ready to test token exchange.');
                },
                onLoad: () => {
                    console.log('🔄 Plaid Link loading...');
                },
                onExit: (err, metadata) => {
                    if (err) {
                        console.error('❌ Plaid Link error:', err);
                    } else {
                        console.log('ℹ️ Plaid Link exited by user');
                    }
                },
                onEvent: (eventName, metadata) => {
                    console.log(`📡 Plaid Link event: ${eventName}`, metadata);
                }
            });

            handler.open();
        }

        // Send Custom Request
        async function sendCustomRequest() {
            const endpoint = endpointSelect.value;
            const [method, path] = endpoint.split(':');
            
            let body = null;
            if (method === 'POST') {
                try {
                    body = JSON.parse(requestBodyTextarea.value);
                } catch (e) {
                    showError('❌ Invalid JSON in request body: ' + e.message);
                    return;
                }
            }
            
            await makeRequest(method, path, body);
        }

        // Generic Request Handler
        async function makeRequest(method, endpoint, body = null) {
            responseContent.textContent = '🔄 Sending request...';
            responseStatus.innerHTML = '';

            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-API-Key': API_KEY
                };

                const requestOptions = {
                    method: method,
                    headers: headers
                };

                if (method === 'POST' && body) {
                    requestOptions.body = JSON.stringify(body);
                }

                console.log(`📤 ${method} ${API_BASE}${endpoint}`);
                console.log('📋 Request options:', requestOptions);

                const response = await fetch(API_BASE + endpoint, requestOptions);
                const data = await response.json();

                const statusClass = response.ok ? 'status-200' : 
                    response.status >= 400 && response.status < 500 ? 'status-400' : 'status-500';
                
                responseStatus.innerHTML = `<span class="status-badge ${statusClass}">${response.status} ${response.statusText}</span>`;
                responseContent.textContent = JSON.stringify(data, null, 2);

                console.log(`📥 Response ${response.status}:`, data);

            } catch (error) {
                showError('❌ Request failed: ' + error.message);
            }
        }

        // Utility Functions
        function getPlaidEnvironment(data) {
            if (data.link_token && data.link_token.includes('sandbox')) {
                return 'sandbox';
            }
            return 'unknown';
        }

        function showValidationResult(type, message) {
            validationResult.style.display = 'flex';
            validationResult.className = `validation-result ${type}`;
            validationIcon.className = `validation-icon ${type}`;
            
            if (type === 'loading') {
                validationIcon.textContent = '⏳';
            } else if (type === 'success') {
                validationIcon.textContent = '✓';
            } else if (type === 'error') {
                validationIcon.textContent = '✗';
            }
            
            validationText.textContent = message;
        }

        function showError(message) {
            responseStatus.innerHTML = '<span class="status-badge status-500">ERROR</span>';
            responseContent.textContent = message + `

🔧 Common troubleshooting steps:
• Ensure the Plaid microservice is running on port 3000
• Check browser console for detailed error messages
• Verify API endpoints are properly configured
• Confirm request body contains valid JSON format`;
        }

        function clearResponse() {
            responseStatus.innerHTML = '';
            responseContent.textContent = '🧹 Response cleared. Ready for new requests...';
        }

        function updateRequestBody() {
            const endpoint = endpointSelect.value;
            
            if (endpoint.includes('/link-token')) {
                requestBodyTextarea.value = JSON.stringify({
                    user_id: "user_12345",
                    client_name: "Test Application",
                    country_codes: ["US"],
                    language: "en",
                    products: ["transactions", "identity"]
                }, null, 2);
            } else if (endpoint.includes('/exchange-token')) {
                requestBodyTextarea.value = JSON.stringify({
                    public_token: "public-sandbox-token-placeholder",
                    user_id: "user_12345"
                }, null, 2);
            } else if (endpoint.includes('/accounts') || endpoint.includes('/transactions') || endpoint.includes('/identity')) {
                requestBodyTextarea.value = JSON.stringify({
                    access_token: "access-sandbox-token-placeholder"
                }, null, 2);
            }
        }
    </script>
</body>
</html>