<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plaid Microservice Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #140d1c);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .quick-test {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .test-area {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        textarea.form-control {
            height: 120px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .response-box {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-200 { background: #10b981; color: white; }
        .status-400 { background: #f59e0b; color: white; }
        .status-500 { background: #dc2626; color: white; }

        .api-validation {
            background: #f0f9ff;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .validation-result {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .validation-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .validation-icon.success { background: #10b981; }
        .validation-icon.error { background: #dc2626; }
        .validation-icon.loading { background: #6b7280; animation: spin 1s linear infinite; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Plaid Microservice Test</h1>
            <p>Simple API Testing Interface</p>
            <div class="status-indicator">
                <span>Service Status:</span>
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Checking...</span>
            </div>
        </div>

        <div class="api-validation">
            <h4>Env Validation</h4>
            <button class="btn btn-primary" id="validateApiBtn">Validate Plaid Connection</button>
            <div class="validation-result" id="validationResult" style="display: none;">
                <div class="validation-icon" id="validationIcon">?</div>
                <span id="validationText">Validating...</span>
            </div>
        </div>

        <div class="quick-test">
            <h3>üöÄ Quick Tests</h3>
            <button class="btn btn-primary" id="healthBtn">Health Check</button>
            <button class="btn btn-primary" id="linkTokenBtn">Create Link Token</button>
            <button class="btn btn-primary" id="plaidLinkBtn" disabled>Open Plaid Link Popup</button>
        </div>

        <div class="test-area">
                        <div class="form-group">
                <label>üìù Custom Request Body (JSON):</label>
                <textarea id="requestBody" class="form-control">{
  "user_id": "user_12345",
  "client_name": "Test App",
  "country_codes": ["US"],
  "language": "en",
  "products": ["transactions", "identity"]
}</textarea>
            </div>

            <div class="form-group">
                <label>üéØ Endpoint:</label>
                <select id="endpoint" class="form-control">
                    <option value="GET:/health">GET /health (Health Check)</option>
                    <option value="POST:/link-token">POST /link-token (Create Link Token)</option>
                    <option value="POST:/exchange-token">POST /exchange-token (Exchange Token)</option>
                    <option value="POST:/accounts">POST /accounts (Get Accounts)</option>
                    <option value="POST:/transactions">POST /transactions (Get Transactions)</option>
                    <option value="POST:/identity">POST /identity (Get Identity)</option>
                </select>
            </div>

            <button class="btn btn-primary" id="customRequestBtn">Send Custom Request</button>
            <button class="btn" id="clearBtn" style="background: #6b7280; color: white;">Clear Response</button>

            <div id="response-status"></div>
            <div id="response-content" class="response-box">
Quick tests:
1. Click "Validate API Key" to verify your Plaid credentials
2. Click "Health Check" to verify the service is running
3. Click "Create Link Token" to test the core Plaid functionality
4. Use the custom request form below for other endpoints

Response will appear here...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let currentLinkToken = null;
        let isApiValidated = false;

        // DOM elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const validateApiBtn = document.getElementById('validateApiBtn');
        const validationResult = document.getElementById('validationResult');
        const validationIcon = document.getElementById('validationIcon');
        const validationText = document.getElementById('validationText');
        const healthBtn = document.getElementById('healthBtn');
        const linkTokenBtn = document.getElementById('linkTokenBtn');
        const plaidLinkBtn = document.getElementById('plaidLinkBtn');
        const customRequestBtn = document.getElementById('customRequestBtn');
        const clearBtn = document.getElementById('clearBtn');
        const endpointSelect = document.getElementById('endpoint');
        const requestBodyTextarea = document.getElementById('requestBody');

        // Event listeners
        validateApiBtn.addEventListener('click', validateApiKey);
        healthBtn.addEventListener('click', testHealth);
        linkTokenBtn.addEventListener('click', testLinkToken);
        plaidLinkBtn.addEventListener('click', openPlaidLink);
        customRequestBtn.addEventListener('click', sendCustomRequest);
        clearBtn.addEventListener('click', clearResponse);
        endpointSelect.addEventListener('change', updateRequestBody);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServiceHealth();
        });

        async function checkServiceHealth() {
            try {
                const response = await fetch(API_BASE + '/health');
                const data = await response.json();
                
                if (response.ok) {
                    statusDot.classList.add('connected');
                    statusText.textContent = `Connected (${data.plaid_environment || 'unknown'})`;
                } else {
                    statusText.textContent = 'Service Error';
                }
            } catch (error) {
                statusText.textContent = 'Service Offline';
            }
        }

        async function validateApiKey() {
    showValidationResult('loading', 'Validating connection...');

    try {
        const testBody = {
            user_id: "test_validation_" + Date.now(),
            client_name: "Connection Validation Test",
            country_codes: ["US"],
            language: "en",
            products: ["transactions"]
        };

        const response = await fetch(API_BASE + '/link-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testBody)
        });

        const data = await response.json();

        if (response.ok && data.link_token) {
            isApiValidated = true;
            plaidLinkBtn.disabled = false;
            showValidationResult('success', `‚úÖ Connection valid! Connected to ${getPlaidEnvironment(data)} environment`);
            
            // Update status indicator
            statusDot.classList.add('connected');
            statusText.textContent = `Connection Validated (${getPlaidEnvironment(data)})`;
        } else {
            isApiValidated = false;
            showValidationResult('error', `‚ùå Connection failed: ${data.error || data.details || 'Unknown error'}`);
        }
    } catch (error) {
        isApiValidated = false;
        showValidationResult('error', `‚ùå Connection failed: ${error.message}`);
    }
}
            showValidationResult('loading', 'Validating API key...');

            try {
                // Test API key by trying to create a link token
                const testBody = {
                    user_id: "test_validation_" + Date.now(),
                    client_name: "API Key Validation Test",
                    country_codes: ["US"],
                    language: "en",
                    products: ["transactions"]
                };

                const response = await fetch(API_BASE + '/link-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testBody)
                });

                const data = await response.json();

                if (response.ok && data.link_token) {
                    isApiValidated = true;
                    plaidLinkBtn.disabled = false;
                    showValidationResult('success', `‚úÖ API key valid! Connected to ${getPlaidEnvironment(data)} environment`);
                    
                    // Update status indicator
                    statusDot.classList.add('connected');
                    statusText.textContent = `API Validated (${getPlaidEnvironment(data)})`;
                } else {
                    isApiValidated = false;
                    showValidationResult('error', `‚ùå API key invalid: ${data.error || data.details || 'Unknown error'}`);
                }
            } catch (error) {
                isApiValidated = false;
                showValidationResult('error', `‚ùå Connection failed: ${error.message}`);
            }
        

        function getPlaidEnvironment(data) {
            // Try to determine environment from link token or other indicators
            if (data.link_token && data.link_token.includes('sandbox')) {
                return 'sandbox';
            }
            return process.env.PLAID_ENV || 'unknown';
        }

        function showValidationResult(type, message) {
            validationResult.style.display = 'flex';
            validationIcon.className = `validation-icon ${type}`;
            
            if (type === 'loading') {
                validationIcon.textContent = '...';
            } else if (type === 'success') {
                validationIcon.textContent = '‚úì';
            } else if (type === 'error') {
                validationIcon.textContent = '‚úó';
            }
            
            validationText.textContent = message;
        }

        async function testHealth() {
            await makeRequest('GET', '/health');
        }

        async function testLinkToken() {
            const body = {
                user_id: "test_user_" + Date.now(),
                client_name: "Test App",
                country_codes: ["US"],
                language: "en",
                products: ["transactions", "identity"]
            };
            
            const result = await makeRequest('POST', '/link-token', body);
            
            // Extract link_token from response for use with Plaid Link
            try {
                const responseContent = document.getElementById('response-content').textContent;
                const response = JSON.parse(responseContent);
                if (response.link_token) {
                    currentLinkToken = response.link_token;
                    plaidLinkBtn.disabled = false;
                    console.log('Link token stored:', currentLinkToken);
                }
            } catch (e) {
                console.error('Could not extract link token from response');
            }
        }

        function openPlaidLink() {
            if (!currentLinkToken) {
                alert('Please create a link token first by clicking "Create Link Token"');
                return;
            }

            const handler = Plaid.create({
                token: currentLinkToken,
                onSuccess: (public_token, metadata) => {
                    console.log('‚úÖ Plaid Link Success!');
                    console.log('Public Token:', public_token);
                    console.log('Metadata:', metadata);
                    
                    // Auto-populate exchange token request
                    requestBodyTextarea.value = JSON.stringify({
                        public_token: public_token,
                        user_id: "test_user_123"
                    }, null, 2);
                    
                    // Auto-select exchange token endpoint
                    endpointSelect.value = "POST:/exchange-token";
                    
                    alert('‚úÖ Bank connected successfully! You can now test token exchange.');
                },
                onLoad: () => {
                    console.log('Plaid Link loaded');
                },
                onExit: (err, metadata) => {
                    console.log('Plaid Link exited', err, metadata);
                    if (err) {
                        console.error('Link error:', err);
                    }
                },
                onEvent: (eventName, metadata) => {
                    console.log('Plaid Link event:', eventName, metadata);
                }
            });

            handler.open();
        }

        async function sendCustomRequest() {
            const endpoint = endpointSelect.value;
            const [method, path] = endpoint.split(':');
            
            let body = null;
            if (method === 'POST') {
                try {
                    body = JSON.parse(requestBodyTextarea.value);
                } catch (e) {
                    showError('Invalid JSON in request body: ' + e.message);
                    return;
                }
            }
            
            await makeRequest(method, path, body);
        }

        async function makeRequest(method, endpoint, body = null) {
           
            const responseStatus = document.getElementById('response-status');
            const responseContent = document.getElementById('response-content');

            responseContent.textContent = 'Sending request...';
            responseStatus.innerHTML = '';

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                const requestOptions = {
                    method: method,
                    headers: headers
                };

                if (method === 'POST' && body) {
                    requestOptions.body = JSON.stringify(body);
                }

                console.log('Making request to:', API_BASE + endpoint);
                console.log('Request options:', requestOptions);

                const response = await fetch(API_BASE + endpoint, requestOptions);
                const data = await response.json();

                const statusClass = response.ok ? 'status-200' : 
                    response.status >= 400 && response.status < 500 ? 'status-400' : 'status-500';
                
                responseStatus.innerHTML = `<span class="status-badge ${statusClass}">${response.status} ${response.statusText}</span>`;
                responseContent.textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                showError('Request failed: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('response-status').innerHTML = '<span class="status-badge status-500">ERROR</span>';
            document.getElementById('response-content').textContent = message + `

Common issues:
- Make sure the service is running on port 3000
- Check the browser console for CORS errors
- Verify the API key is correct
- Ensure the request body is valid JSON`;
        }

        function clearResponse() {
            document.getElementById('response-status').innerHTML = '';
            document.getElementById('response-content').textContent = 'Response cleared. Send a request to see results here.';
        }

        function updateRequestBody() {
            const endpoint = endpointSelect.value;
            
            if (endpoint.includes('/link-token')) {
                requestBodyTextarea.value = JSON.stringify({
                    user_id: "user_12345",
                    client_name: "Test App",
                    country_codes: ["US"],
                    language: "en",
                    products: ["transactions", "identity"]
                }, null, 2);
            } else if (endpoint.includes('/exchange-token')) {
                requestBodyTextarea.value = JSON.stringify({
                    public_token: "public-sandbox-abc123-def456",
                    user_id: "user_12345"
                }, null, 2);
            } else if (endpoint.includes('/accounts') || endpoint.includes('/transactions') || endpoint.includes('/identity')) {
                requestBodyTextarea.value = JSON.stringify({
                    access_token: "access-sandbox-xyz789-abc123"
                }, null, 2);
            }
        }
    </script>
</body>
</html>